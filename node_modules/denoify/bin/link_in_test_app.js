"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
const child_process_1 = require("child_process");
const path_1 = require("path");
const fs = require("fs");
const denoifyDirPath = (0, path_1.join)(__dirname, "..", "..");
fs.writeFileSync((0, path_1.join)(denoifyDirPath, "dist", "package.json"), Buffer.from(JSON.stringify((() => {
    const packageJsonParsed = JSON.parse(fs.readFileSync((0, path_1.join)(denoifyDirPath, "package.json")).toString("utf8"));
    return {
        ...packageJsonParsed,
        "main": packageJsonParsed["main"].replace(/^dist\//, ""),
        "types": packageJsonParsed["types"].replace(/^dist\//, "")
    };
})(), null, 2), "utf8"));
const commonThirdPartyDeps = (() => {
    const namespaceModuleNames = [];
    const standaloneModuleNames = ["tsafe", "evt"];
    return [
        ...namespaceModuleNames
            .map(namespaceModuleName => fs
            .readdirSync((0, path_1.join)(denoifyDirPath, "node_modules", namespaceModuleName))
            .map(submoduleName => `${namespaceModuleName}/${submoduleName}`))
            .reduce((prev, curr) => [...prev, ...curr], []),
        ...standaloneModuleNames
    ];
})();
const yarnHomeDirPath = (0, path_1.join)(denoifyDirPath, ".yarn_home");
(0, child_process_1.execSync)(["rm -rf", "mkdir"].map(cmd => `${cmd} ${yarnHomeDirPath}`).join(" && "));
const execYarnLink = (params) => {
    const { targetModuleName, cwd } = params;
    const cmd = ["yarn", "link", ...(targetModuleName !== undefined ? [targetModuleName] : [])].join(" ");
    console.log(`$ cd ${(0, path_1.relative)(denoifyDirPath, cwd) || "."} && ${cmd}`);
    (0, child_process_1.execSync)(cmd, {
        cwd,
        "env": {
            ...process.env,
            "HOME": yarnHomeDirPath
        }
    });
};
const testAppNames = [(_a = process.argv[2]) !== null && _a !== void 0 ? _a : "my_dummy_npm_and_deno_module"];
const getTestAppPath = (testAppName) => (0, path_1.join)(denoifyDirPath, "..", testAppName);
testAppNames.forEach(testAppName => (0, child_process_1.execSync)("yarn install", { "cwd": getTestAppPath(testAppName) }));
console.log("=== Linking common dependencies ===");
const total = commonThirdPartyDeps.length;
let current = 0;
commonThirdPartyDeps.forEach(commonThirdPartyDep => {
    current++;
    console.log(`${current}/${total} ${commonThirdPartyDep}`);
    const localInstallPath = (0, path_1.join)(...[denoifyDirPath, "node_modules", ...(commonThirdPartyDep.startsWith("@") ? commonThirdPartyDep.split("/") : [commonThirdPartyDep])]);
    execYarnLink({ "cwd": localInstallPath });
    testAppNames.forEach(testAppName => execYarnLink({
        "cwd": getTestAppPath(testAppName),
        "targetModuleName": commonThirdPartyDep
    }));
});
console.log("=== Linking in house dependencies ===");
execYarnLink({ "cwd": (0, path_1.join)(denoifyDirPath, "dist") });
testAppNames.forEach(testAppName => execYarnLink({
    "cwd": getTestAppPath(testAppName),
    "targetModuleName": "denoify"
}));
//# sourceMappingURL=link_in_test_app.js.map